name: Cleanup Docker Images

on:
  schedule:
    - cron: '0 3 * * 0'  # 每周日 03:00 UTC
  workflow_dispatch:

env:
  KEEP_DAYS: 30
  KEEP_TAGS: 'ubuntu2404|debian12'  # 保留不带哈希的基础 tag

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      packages: write

    steps:
      - name: Delete images older than ${{ env.KEEP_DAYS }} days
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CUTOFF=$(date -d "-$KEEP_DAYS days" +%s)
          OWNER="${{ github.repository_owner }}"
          PACKAGE="vicinae-builder"

          echo "Cleaning up images older than $KEEP_DAYS days (before $(date -d @$CUTOFF))"

          # 获取所有版本
          gh api --paginate \
            "/users/$OWNER/packages/container/$PACKAGE/versions" \
            --jq '.[] | select(.metadata.container.tags | length > 0) | {id, tags: .metadata.container.tags, updated: .updated_at}' |
          while read -r version; do
            ID=$(echo "$version" | jq -r '.id')
            TAGS=$(echo "$version" | jq -r '.tags | join(",")')
            UPDATED=$(echo "$version" | jq -r '.updated')
            UPDATED_TS=$(date -d "$UPDATED" +%s)

            # 跳过受保护的 tag
            if echo "$TAGS" | tr ',' '\n' | grep -qE "^($KEEP_TAGS)$"; then
              echo "Keeping protected tag: $TAGS"
              continue
            fi

            # 删除超过 KEEP_DAYS 天的版本
            if [ "$UPDATED_TS" -lt "$CUTOFF" ]; then
              echo "Deleting: $TAGS (updated: $UPDATED)"
              gh api --method DELETE "/users/$OWNER/packages/container/$PACKAGE/versions/$ID" || true
            fi
          done

          echo "Cleanup complete"
